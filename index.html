<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheetrock Advanced Estimator v2.0</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic enhancements and mobile layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            min-height: 100vh;
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .input-group input, .input-group select {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .result-box {
            background-color: #e5f0ff;
            border: 1px solid #3b82f6;
        }
        .cost-adj-input { background-color: #f0f9ff; border-left: 3px solid #60a5fa; }
        .finish-price-input { background-color: #fefce8; border-left: 3px solid #fcd34d; }
        .rate-adder-input { background-color: #f2eaff; border-left: 3px solid #a78bfa; } 
        .final-rate {
            background-color: #d1f7d1;
            border: 1px solid #10b981;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        /* Style for the validation warning block */
        #validationWarning {
            background-color: #fee2e2;
            border: 2px solid #ef4444;
            color: #b91c1c;
            animation: pulse-red 1s infinite alternate;
        }
        @keyframes pulse-red {
            from { box-shadow: 0 0 5px rgba(239, 68, 68, 0.4); }
            to { box-shadow: 0 0 10px rgba(239, 68, 68, 0.8); }
        }
        /* Styling for the collapsible section */
        #advancedPricingSection {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        #advancedPricingSection.expanded {
            max-height: 1000px; /* Large enough value to cover content */
            opacity: 1;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px dashed #e5e7eb;
        }
        /* Rate breakdown for Floor Area (3 columns) */
        .rate-breakdown-floor {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        /* Rate breakdown for Sheetrock Area (2 columns) */
        .rate-breakdown-sheetrock {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
    </style>
</head>
<body class="p-4 flex items-start justify-center">

    <div id="app" class="w-full max-w-6xl mt-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Sheetrock Advanced Estimator</h1>
            <p class="text-gray-500">The daily quoting screen, focused on project dimensions and complexity.</p>
        </header>

        <!-- Main Card Container -->
        <div class="card bg-white p-6 md:p-8 rounded-xl space-y-8">
            
            <!-- Preset Buttons (UPDATED - Now decoupled from Advanced Settings) -->
            <section class="border-b pb-4">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">Quick Layout Presets</h2>
                <p class="text-sm text-gray-500 mb-3">Instantly define project scale and complexity. **Does not change your Advanced Pricing settings.**</p>
                <div class="flex flex-wrap gap-3">
                    <button onclick="loadPreset('SIMPLE_TRACK')" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-150 text-sm text-left">Simple Track Home (1600 sq ft, 8ft flat)</button>
                    <button onclick="loadPreset('CUSTOM_MEDIUM')" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-150 text-sm text-left">Custom Home (2500 sq ft, 9ft & 16ft high area)</button>
                    <button onclick="loadPreset('COMPLEX_CUSTOM')" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-150 text-sm text-left">Complex Custom (3000 sq ft, varying heights, cut up)</button>
                </div>
            </section>

            <!-- Section 1: Global Inputs & Base Pricing -->
            <section>
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">1. Project Dimensions & Complexity</h2>
                
                <!-- Main visible inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    
                    <!-- Column 1: Base Input (Area) -->
                    <div class="space-y-4 lg:col-span-2">
                        <h3 class="font-medium text-gray-600 border-b pb-1">Base Project Inputs (Per-Job)</h3>
                        <div class="input-group flex flex-col">
                            <label for="totalFloorArea" class="mb-1">Total Floor Plan Area (sq ft)</label>
                            <input type="number" id="totalFloorArea" placeholder="e.g., 2500" min="1" value="2500" oninput="calculateEstimate()">
                            <p class="text-xs text-gray-400 mt-1">Total heated and finished area being sheetrocked.</p>
                        </div>
                    </div>
                    
                    <!-- Column 2: Complexity Multipliers -->
                    <div class="space-y-4 lg:col-span-3">
                        <h3 class="font-medium text-gray-600 border-b pb-1">Complexity Multipliers (Per-Job)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="input-group flex flex-col">
                                <label for="cutUpFactor" class="mb-1">Overall Project Complexity</label>
                                <select id="cutUpFactor" onchange="calculateEstimate()">
                                    <option value="0.00">Low Complexity (0.00x Rate Adj)</option>
                                    <option value="0.03" selected>Medium Complexity (+0.03x Rate Adj)</option>
                                    <option value="0.06">High Complexity (+0.06x Rate Adj)</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Adjusts labor rate based on corners, non-standard framing, and cut-up areas.</p>
                            </div>
                            <div class="input-group flex flex-col">
                                <label for="homeType" class="mb-1">Select Home Type Pricing Tier</label>
                                <select id="homeType" onchange="calculateEstimate()">
                                    <option value="TRACK">Track Home</option>
                                    <option value="CUSTOM_BASIC" selected>Custom Home Basic</option>
                                    <option value="CUSTOM_COMPLEX">Custom Home Complex</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Applies your company's predetermined pricing adder for this market segment.</p>
                            </div>
                        </div>

                        <!-- ADVANCED PRICING TEMPLATE BUTTON -->
                        <div class="pt-4">
                            <button onclick="toggleAdvancedSettings()" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150 flex justify-center items-center text-sm">
                                <span id="toggleText">Show Advanced Pricing Template (Company Constants)</span>
                                <svg id="toggleIcon" class="h-4 w-4 ml-2 transform rotate-0 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- HIDDEN SECTION: Template Management Inputs (All your company's constants) -->
                <div id="advancedPricingSection" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Column 1: Base Rate & Bead Cost -->
                    <div class="space-y-4">
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1">Global Base Costs (Template)</h3>
                        <div class="input-group flex flex-col">
                            <label for="footagePrice" class="mb-1 text-sm text-purple-700">All-in Base Price ($/sq ft)</label>
                            <input type="number" id="footagePrice" placeholder="e.g., 1.50" value="1.50" step="0.01" min="0" oninput="calculateEstimate()" class="rate-adder-input">
                            <p class="text-xs text-gray-400 mt-1">The constant starting price (Labor + Materials) before any adjustments.</p>
                        </div>
                        <div class="input-group flex flex-col pt-2 border-t mt-4 border-gray-200">
                            <label for="beadPricePerLf" class="mb-1 text-sm text-red-700">Corner Bead Price/LF ($)</label>
                            <input type="number" id="beadPricePerLf" placeholder="e.g., 1.50" value="1.50" min="0" step="0.01" oninput="calculateEstimate()" class="rate-adder-input">
                            <p class="text-xs text-gray-400 mt-1">The constant price used for the calculated linear feet of bead.</p>
                        </div>
                    </div>
                    
                    <!-- Column 2: Home Type Rate Adders -->
                    <div class="space-y-4">
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1">Home Type Rate Adders ($/sq ft)</h3>
                        <div class="input-group flex flex-col">
                            <label for="trackAdageRate" class="mb-1 text-sm text-purple-700">Track Home Rate Adder</label>
                            <input type="number" id="trackAdageRate" placeholder="e.g., 0.00" value="0.00" min="0" step="0.01" oninput="calculateEstimate()" class="rate-adder-input">
                        </div>
                        <div class="input-group flex flex-col">
                            <label for="customBasicAdageRate" class="mb-1 text-sm text-purple-700">Custom Basic Rate Adder</label>
                            <input type="number" id="customBasicAdageRate" placeholder="e.g., 0.20" value="0.20" min="0" step="0.01" oninput="calculateEstimate()" class="rate-adder-input">
                        </div>
                        <div class="input-group flex flex-col">
                            <label for="customComplexAdageRate" class="mb-1 text-sm text-purple-700">Custom Complex Rate Adder</label>
                            <input type="number" id="customComplexAdageRate" placeholder="e.g., 0.40" value="0.40" min="0" step="0.01" oninput="calculateEstimate()" class="rate-adder-input">
                        </div>
                    </div>

                    <!-- Column 3: Finish Level Price/Sq Ft Adders -->
                    <div class="space-y-4">
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1">Finish Level Price Adders ($/sq ft)</h3>
                        <div class="input-group flex flex-col">
                            <label for="l3PriceAdage" class="mb-1 text-sm text-yellow-700">Level 3 Price/Sq Ft Adder</label>
                            <input type="number" id="l3PriceAdage" placeholder="e.g., 0.00" value="0.00" min="0" step="0.01" oninput="calculateEstimate()" class="finish-price-input">
                        </div>
                        <div class="input-group flex flex-col">
                            <label for="l4PriceAdage" class="mb-1 text-sm text-yellow-700">Level 4 Price/Sq Ft Adder</label>
                            <input type="number" id="l4PriceAdage" placeholder="e.g., 0.05" value="0.10" min="0" step="0.01" oninput="calculateEstimate()" class="finish-price-input">
                        </div>
                        <div class="input-group flex flex-col">
                            <label for="l5PriceAdage" class="mb-1 text-sm text-yellow-700">Level 5 Price/Sq Ft Adder</label>
                            <input type="number" id="l5PriceAdage" placeholder="e.g., 0.10" value="0.25" min="0" step="0.01" oninput="calculateEstimate()" class="finish-price-input">
                        </div>
                    </div>

                </div>
            </section>

            <!-- Section 2: Height Sections (Dynamic) -->
            <section>
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">2. Ceiling Height Sections & Local Adders</h2>
                <p class="text-sm text-gray-500 mb-4">Define area, height, finish level (impacts price/sq ft), and any section-specific costs (local adders).</p>
                
                <div id="sectionsContainer" class="space-y-4">
                    <!-- Initial Section will be added by JS -->
                </div>
                
                <button onclick="addSection()" class="mt-4 w-full md:w-auto bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-150">
                    + Add Height Section
                </button>

                <div id="areaSummary" class="mt-4 text-sm font-medium p-2 rounded-lg bg-gray-100 text-gray-600">
                    Total Area Defined: 0 sq ft / 0 sq ft
                </div>
            </section>

            <!-- Section 3: Results Display -->
            <section>
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">3. Estimated Results & Actions</h2>

                <!-- Validation Warning Block -->
                <div id="validationWarning" class="p-4 rounded-xl mb-6 text-lg font-bold flex items-center hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                    <span id="validationMessage">ATTENTION: Area validation failed.</span>
                </div>
                
                <div id="resultsContainer" class="result-box p-4 rounded-xl space-y-4">
                    
                    <!-- Row 1: Key Cost Drivers & Multipliers -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm border-b pb-3 border-blue-300">
                        <p class="font-medium text-gray-700">Estimated Sheetrock Area: <span id="estimatedArea" class="font-bold text-blue-700">0 sq ft</span></p>
                        <p class="font-medium text-gray-700">Estimated Corner Bead LF: <span id="estimatedBeadLf" class="font-bold text-red-700">0 LF</span></p>
                        <p class="font-medium text-gray-700">Effective Sheetrock Multiplier: <span id="effectiveMultiplier" class="font-bold text-blue-500">0.000x</span></p>
                    </div>

                    <!-- Row 2: RATE BREAKDOWN PER SHEETROCK AREA (NEW & CRITICAL SECTION) -->
                    <h4 class="text-lg font-bold text-gray-700 pt-2 border-t mt-4">Cost Breakdown Per Sheetrock Sq Ft</h4>
                    <div class="rate-breakdown-sheetrock">
                        <div class="bg-blue-100 p-3 rounded-lg flex flex-col justify-center items-center text-center">
                            <p class="text-sm font-semibold text-blue-700">Weighted Avg Labor Rate / Sheetrock Sq Ft</p>
                            <p id="weightedAvgLaborRatePerSheetrockSqFt" class="text-xl font-bold text-blue-700">$0.00</p>
                        </div>
                        <div class="final-rate flex flex-col justify-center items-center text-center">
                            <p class="text-sm font-extrabold text-green-700">All-In Price / Sheetrock Sq Ft (Labor + Fixed Materials)</p>
                            <p id="weightedAvgAllInRatePerSheetrockSqFt" class="text-2xl font-extrabold text-green-700">$0.00</p>
                        </div>
                    </div>

                    <hr class="border-blue-300">
                    
                    <!-- Row 3: DOLLAR TOTALS (Labor and Materials Final Outputs) -->
                    <h4 class="text-lg font-bold text-gray-700 pt-2 border-t mt-4">Total Outputs (Labor, Materials, Adders)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-lg font-medium">
                         <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-gray-800">Total Labor Cost:</p>
                            <p id="totalLaborCostDisplay" class="font-bold text-blue-700">$0.00</p>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-gray-800">Total Fixed Materials Cost:</p>
                            <p id="estimatedMaterialsCostDisplay" class="font-bold text-red-600">$0.00</p>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-gray-800">Total Bead/Adage Adders:</p>
                            <p id="totalAddersCost" class="font-bold text-red-600">$0.00</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-blue-400">
                        <p class="text-lg font-medium text-gray-800">TOTAL PROJECT CHARGE:</p>
                        <p id="estimatedCost" class="text-3xl font-extrabold text-blue-700">$0.00</p>
                    </div>
                    
                    <hr class="border-blue-300">

                    <!-- Row 4: RATE BREAKDOWN PER FLOOR AREA (Previous implementation) -->
                    <h4 class="text-lg font-bold text-gray-700 pt-2 border-t mt-4">Cost Breakdown Per Floor Plan Sq Ft</h4>
                    <div class="rate-breakdown-floor pt-2">
                        <div class="final-rate flex flex-col justify-center items-center text-center">
                            <p class="text-sm font-extrabold text-green-700">1. Total All-In Price / Floor Sq Ft</p>
                            <p id="ratePerSqFt" class="text-2xl font-extrabold text-green-700">$0.00</p>
                        </div>
                        <div class="bg-blue-100 p-2 rounded-lg flex flex-col justify-center items-center text-center">
                            <p class="text-sm font-semibold text-blue-700">2. Labor Price / Floor Sq Ft</p>
                            <p id="laborRatePerSqFt" class="text-xl font-bold text-blue-700">$0.00</p>
                        </div>
                        <div class="bg-red-100 p-2 rounded-lg flex flex-col justify-center items-center text-center">
                            <p class="text-sm font-semibold text-red-700">3. Materials Price / Floor Sq Ft</p>
                            <p id="materialsRatePerSqFt" class="text-xl font-bold text-red-700">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons & Summary Output -->
                <div class="mt-8 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="generateShareableLink()" class="bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-150">
                            Generate Shareable Link
                        </button>
                        <button onclick="generateCustomerSummary()" class="bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-teal-700 transition duration-150">
                            Generate Customer Summary
                        </button>
                    </div>
                    
                    <!-- Modal/Output for Summary and Link -->
                    <div id="outputModal" class="p-4 bg-gray-100 border border-gray-300 rounded-lg hidden">
                        <h4 id="outputTitle" class="font-bold mb-2 text-gray-700"></h4>
                        <textarea id="outputTextarea" rows="18" class="w-full p-2 text-sm border rounded-md resize-none" readonly></textarea>
                        <button onclick="copyToClipboard('outputTextarea')" class="mt-2 bg-blue-500 text-white text-sm py-1 px-3 rounded hover:bg-blue-600 transition duration-150">Copy to Clipboard</button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        let sectionCount = 0;

        // Constants based on original vb1 logic
        const BASE_HEIGHT = 8;
        const BASE_MULTIPLIER_8FT = 3.33;
        const INCREMENT_PER_FOOT = 0.25;
        // CRITICAL CONSTANT: Fixed Materials cost per square foot of Sheetrock Area
        const MATERIALS_COST_PER_SQFT = 0.73; 

        // Map Home Type to its internal Base Bead Factor
        const HOME_TYPE_BEAD_FACTORS = {
            'TRACK': 0.05,        // Low complexity
            'CUSTOM_BASIC': 0.10, // Medium complexity
            'CUSTOM_COMPLEX': 0.15 // High complexity
        };

        // Map of URL Parameter Key to Input ID (for loading)
        const URL_PARAM_MAP = {
            'bp': 'footagePrice',
            'ta': 'totalFloorArea',
            'cut': 'cutUpFactor',
            'ht': 'homeType',
            'TAr': 'trackAdageRate', 
            'CBAr': 'customBasicAdageRate',
            'CCAr': 'customComplexAdageRate',
            'L3p': 'l3PriceAdage',
            'L4p': 'l4PriceAdage',
            'L5p': 'l5PriceAdage',
            'bpl': 'beadPricePerLf',
        };

        // NEW PRESET STRUCTURE: Defines complexity, home type, area, and initial sections.
        const PRESETS = {
            SIMPLE_TRACK: {
                totalFloorArea: 1600, 
                cutUpFactor: '0.00', 
                homeType: 'TRACK',
                // Section structure: [{percent_of_area: float, height: int}]
                sections: [{p: 1.00, h: 8}] 
            },
            CUSTOM_MEDIUM: {
                totalFloorArea: 2500, 
                cutUpFactor: '0.03', 
                homeType: 'CUSTOM_BASIC',
                sections: [
                    {p: 0.65, h: 9}, // 65% @ 9ft
                    {p: 0.35, h: 16} // 35% @ 16ft high area
                ]
            },
            COMPLEX_CUSTOM: {
                totalFloorArea: 3000, 
                cutUpFactor: '0.06', 
                homeType: 'CUSTOM_COMPLEX',
                sections: [
                    {p: 0.40, h: 8}, // 40% @ 8ft
                    {p: 0.35, h: 10}, // 35% @ 10ft
                    {p: 0.25, h: 16} // 25% @ 16ft high area
                ]
            }
        };

        /**
         * Toggles the visibility of the advanced pricing template section.
         */
        function toggleAdvancedSettings() {
            const section = document.getElementById('advancedPricingSection');
            const icon = document.getElementById('toggleIcon');
            const text = document.getElementById('toggleText');
            
            const isExpanded = section.classList.toggle('expanded');
            
            if (isExpanded) {
                icon.classList.add('rotate-180');
                text.textContent = 'Hide Advanced Pricing Template';
            } else {
                icon.classList.remove('rotate-180');
                text.textContent = 'Show Advanced Pricing Template (Company Constants)';
            }
        }


        /**
         * Utility to copy text to clipboard safely.
         */
        function copyToClipboard(elementId) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Copy failed:', err);
            }
        }

        /**
         * Loads a predefined set of complexity, area, and sections.
         * NOTE: This function deliberately AVOIDS touching the Advanced Pricing Template inputs.
         */
        function loadPreset(presetName) {
            const preset = PRESETS[presetName];
            if (!preset) return;

            // 1. Set Global Area and Complexity Inputs
            document.getElementById('totalFloorArea').value = preset.totalFloorArea;
            document.getElementById('cutUpFactor').value = preset.cutUpFactor;
            document.getElementById('homeType').value = preset.homeType;
            
            // 2. Clear Existing Sections
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = '';
            sectionCount = 0; // Reset section counter
            
            // 3. Create New Sections based on preset percentages
            const totalArea = preset.totalFloorArea;

            preset.sections.forEach((s, index) => {
                const area = Math.round(totalArea * s.p);
                // The very first section must be created differently to ensure the 'Remove' button is disabled
                if (index === 0) {
                    addSection(true, area, s.h);
                } else {
                    addSection(false, area, s.h);
                }
            });

            // 4. Recalculate everything
            calculateEstimate();
        }

        /**
         * Loads configuration values from URL parameters and updates the corresponding input fields.
         */
        function loadUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            let paramsFound = false;
            
            for (const [key, elementId] of Object.entries(URL_PARAM_MAP)) {
                const value = params.get(key);
                if (value !== null) {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = value;
                        paramsFound = true;
                    }
                }
            }
            return paramsFound;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Load parameters from the URL first
            const paramsFound = loadUrlParameters(); 
            
            // 2. If no parameters are found, load a default preset (Custom Medium) for a clean start.
            if (!paramsFound) {
                 loadPreset('CUSTOM_MEDIUM');
            } else {
                 // If params were found, we still need to ensure at least one section exists if the user didn't define them via URL.
                 if (document.querySelectorAll('#sectionsContainer > div').length === 0) {
                     // Default to a 100% 8ft section matching the loaded totalFloorArea
                     const totalArea = parseFloat(document.getElementById('totalFloorArea').value) || 2500;
                     addSection(true, totalArea, 9); 
                 }
                 calculateEstimate(); // Recalculate based on loaded data
            }
        });


        /**
         * Calculates the Sheetrock multiplier based on ceiling height and the global base multiplier.
         */
        function calculateMultiplier(height, baseMultiplier) {
            if (typeof height !== 'number' || height <= 0) {
                return 0;
            }
            
            if (height <= BASE_HEIGHT) {
                return baseMultiplier;
            }

            const extraFeet = height - BASE_HEIGHT;
            const multiplierIncrease = Math.floor(extraFeet) * INCREMENT_PER_FOOT;
            const finalMultiplier = baseMultiplier + multiplierIncrease;
            
            return parseFloat(finalMultiplier.toFixed(3));
        }

        /**
         * Adds a new height section input group to the UI.
         * @param {boolean} isInitial - Should the section be treated as the mandatory, non-removable base section.
         * @param {number} defaultArea - The default floor area for this section (used by presets).
         * @param {number} defaultHeight - The default height for this section (used by presets).
         */
        function addSection(isInitial = false, defaultArea = 500, defaultHeight = 9) {
            sectionCount++;
            const id = `section-${sectionCount}`;
            const container = document.getElementById('sectionsContainer');
            
            const newSection = document.createElement('div');
            newSection.id = id;
            newSection.classList.add('bg-white', 'p-4', 'border', 'border-gray-200', 'rounded-lg', 'space-y-4', 'md:grid', 'md:grid-cols-5', 'md:gap-4', 'items-end');
            
            // Set Finish Level to L3 by default (Per requirement 6)
            const defaultFinishLevel = 'L3'; 
            
            newSection.innerHTML = `
                <div class="input-group flex flex-col">
                    <label for="${id}-area" class="mb-1 text-sm">Floor Area (sq ft)</label>
                    <input type="number" id="${id}-area" placeholder="e.g., 1000" min="1" value="${defaultArea}" oninput="calculateEstimate()" class="w-full">
                </div>
                <div class="input-group flex flex-col">
                    <label for="${id}-height" class="mb-1 text-sm">Ceiling Height (ft)</label>
                    <input type="number" id="${id}-height" placeholder="e.g., 9" min="8" value="${defaultHeight}" oninput="calculateEstimate()" class="w-full">
                </div>
                <!-- Finish Level Selector (Defaults to L3) -->
                <div class="input-group flex flex-col">
                    <label for="${id}-finish" class="mb-1 text-sm text-yellow-700">Finish Level</label>
                    <select id="${id}-finish" onchange="calculateEstimate()" class="w-full finish-price-input">
                        <option value="L3" selected>Level 3</option>
                        <option value="L4">Level 4</option>
                        <option value="L5">Level 5</option>
                    </select>
                </div>
                <!-- Additional Cost Consideration (Local Adder) -->
                <div class="input-group flex flex-col">
                    <label for="${id}-adage" class="mb-1 text-sm text-blue-700">Local Adder ($)</label>
                    <input type="number" id="${id}-adage" placeholder="e.g., 150" value="0.00" min="0" oninput="calculateEstimate()" class="w-full cost-adj-input">
                </div>
                <div class="md:col-span-1">
                    ${isInitial ? 
                        '<button class="w-full bg-gray-300 text-gray-600 py-2 px-4 rounded-lg cursor-not-allowed" disabled>Base Section</button>' : 
                        `<button onclick="removeSection('${id}')" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-150">Remove</button>`
                    }
                </div>
            `;

            container.appendChild(newSection);
            calculateEstimate();
        }

        /**
         * Removes a height section from the UI.
         */
        function removeSection(id) {
            const section = document.getElementById(id);
            if (section) {
                section.remove();
                calculateEstimate();
            }
        }

        /**
         * Main function to gather all inputs and calculate the total estimate.
         */
        function calculateEstimate() {
            // --- 1. Get Base Global Inputs and Adder Definitions ---
            const allInBasePrice = parseFloat(document.getElementById('footagePrice').value) || 0;
            const beadPricePerLf = parseFloat(document.getElementById('beadPricePerLf').value) || 0;
            const totalFloorArea = parseFloat(document.getElementById('totalFloorArea').value) || 0;

            // Global Adder Definitions (Home Type and Finish Level)
            const trackAdageRate = parseFloat(document.getElementById('trackAdageRate').value) || 0; 
            const customBasicAdageRate = parseFloat(document.getElementById('customBasicAdageRate').value) || 0;
            const customComplexAdageRate = parseFloat(document.getElementById('customComplexAdageRate').value) || 0;
            const l3PriceAdage = parseFloat(document.getElementById('l3PriceAdage').value) || 0;
            const l4PriceAdage = parseFloat(document.getElementById('l4PriceAdage').value) || 0;
            const l5PriceAdage = parseFloat(document.getElementById('l5PriceAdage').value) || 0;

            // --- 2. Calculate PURE LABOR Base Rate ---
            const pureLaborBaseRate = Math.max(0, allInBasePrice - MATERIALS_COST_PER_SQFT); 
            
            // --- 3. Apply Global Labor Adjustments ---
            const cutUpFactor = parseFloat(document.getElementById('cutUpFactor').value) || 0;
            const selectedHomeType = document.getElementById('homeType').value;
            
            let homeTypeAdj = 0;
            switch (selectedHomeType) {
                case 'TRACK': homeTypeAdj = trackAdageRate; break;
                case 'CUSTOM_BASIC': homeTypeAdj = customBasicAdageRate; break;
                case 'CUSTOM_COMPLEX': homeTypeAdj = customComplexAdageRate; break;
            }
            
            // Base Labor rate before finish level and height multipliers are applied
            const baseLaborRate = pureLaborBaseRate + cutUpFactor + homeTypeAdj;
            
            // Area Multiplier is affected by the Cut-Up Factor
            const baseAreaMultiplier = BASE_MULTIPLIER_8FT + cutUpFactor; 

            // --- 4. Process Height Sections ---
            let totalSheetrockArea = 0;
            let totalDefinedArea = 0;
            let totalSectionAdageCost = 0; 
            let totalLaborCost = 0; // Total calculated labor cost
            let finalFinishLevel = 'L3'; 

            const sections = document.querySelectorAll('#sectionsContainer > div');
            
            sections.forEach(section => {
                const floorArea = parseFloat(section.querySelector('[id$="-area"]').value) || 0;
                const ceilingHeight = parseFloat(section.querySelector('[id$="-height"]').value) || 0;
                const sectionAdage = parseFloat(section.querySelector('[id$="-adage"]').value) || 0;
                const selectedFinish = section.querySelector('[id$="-finish"]') ? section.querySelector('[id$="-finish"]').value : 'L3'; 
                
                // Track the highest finish level 
                if (selectedFinish === 'L5') finalFinishLevel = 'L5';
                else if (selectedFinish === 'L4' && finalFinishLevel !== 'L5') finalFinishLevel = 'L4';
                
                totalSectionAdageCost += sectionAdage;

                let finishPriceAdage = 0;
                switch (selectedFinish) {
                    case 'L3': finishPriceAdage = l3PriceAdage; break;
                    case 'L4': finishPriceAdage = l4PriceAdage; break;
                    case 'L5': finishPriceAdage = l5PriceAdage; break;
                }
                
                if (floorArea > 0 && ceilingHeight >= 8) {
                    const finalAreaMultiplier = calculateMultiplier(ceilingHeight, baseAreaMultiplier);
                    const sectionSheetrockArea = floorArea * finalAreaMultiplier;
                    
                    totalSheetrockArea += sectionSheetrockArea;
                    totalDefinedArea += floorArea;

                    // The effective LABOR price for THIS section = Base Labor Rate + Finish Adder
                    const sectionEffectiveLaborPrice = baseLaborRate + finishPriceAdage;
                    const sectionLaborCost = (sectionSheetrockArea * sectionEffectiveLaborPrice);
                    totalLaborCost += sectionLaborCost;
                }
            });
            
            // --- 5. Final Cost Assembly (Materials are included ONCE based on total Sheetrock Area) ---

            // A. Dynamic Corner Bead Calculation 
            const homeTypeBaseBeadFactor = HOME_TYPE_BEAD_FACTORS[selectedHomeType] || HOME_TYPE_BEAD_FACTORS['CUSTOM_BASIC'];
            const finalBeadFactor = homeTypeBaseBeadFactor + cutUpFactor;
            
            const estimatedBeadLf = totalSheetrockArea * finalBeadFactor;
            const beadCost = estimatedBeadLf * beadPricePerLf;
            
            // All Adders/Adage Cost = Local Section Adders + Calculated Bead Cost
            const totalAddersCost = totalSectionAdageCost + beadCost;
            
            // B. Estimated Materials Cost (Fixed $0.73/sq ft of Sheetrock Area)
            const estimatedMaterialsCost = totalSheetrockArea * MATERIALS_COST_PER_SQFT;
            
            // C. Final Total Cost = Total Labor Cost + Total Materials Cost + All Adders
            const estimatedTotalCost = totalLaborCost + estimatedMaterialsCost + totalAddersCost; 

            // Effective Multiplier (weighted average)
            const effectiveOverallMultiplier = totalDefinedArea > 0 ? (totalSheetrockArea / totalDefinedArea) : 0;

            // --- 6. New Rate Breakdown (Per Sheetrock Sq Ft) ---
            
            const weightedAvgLaborRatePerSheetrockSqFt = totalSheetrockArea > 0 ? (totalLaborCost / totalSheetrockArea) : 0;
            
            // This is the new CRITICAL METRIC requested: Labor + Fixed Materials
            const weightedAvgAllInRatePerSheetrockSqFt = totalSheetrockArea > 0 ? ((totalLaborCost + estimatedMaterialsCost) / totalSheetrockArea) : 0;
            
            // --- 7. New Rate Breakdown (Per Floor Sq Ft) ---

            // 1. Total All-In Price / Floor Sq Ft
            const ratePerFloorPlanSqFt = totalFloorArea > 0 ? (estimatedTotalCost / totalFloorArea) : 0;
            
            // 2. Total Labor Price / Floor Sq Ft
            const laborRatePerFloorPlanSqFt = totalFloorArea > 0 ? (totalLaborCost / totalFloorArea) : 0;
            
            // 3. Total Materials Price / Floor Sq Ft (Includes fixed materials + calculated bead cost)
            const materialsPriceComponent = estimatedMaterialsCost + beadCost;
            const materialsRatePerFloorPlanSqFt = totalFloorArea > 0 ? (materialsPriceComponent / totalFloorArea) : 0;

            // --- 8. Validation and UI Update ---

            const isAreaValid = totalDefinedArea === totalFloorArea;
            const validationWarning = document.getElementById('validationWarning');
            const validationMessage = document.getElementById('validationMessage');
            const resultsContainer = document.getElementById('resultsContainer');
            const isReadyToCalculate = isAreaValid && totalFloorArea > 0;

            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 });

            if (!isReadyToCalculate) {
                validationWarning.classList.remove('hidden');
                resultsContainer.classList.add('opacity-50', 'pointer-events-none');
                
                if (totalDefinedArea !== totalFloorArea) {
                    validationMessage.innerHTML = `ATTENTION: Total Area defined in sections (${totalDefinedArea.toFixed(0)} sq ft) **must** match the Global Total Floor Area (${totalFloorArea.toFixed(0)} sq ft) to finalize the estimate.`;
                } else if (totalFloorArea === 0) {
                     validationMessage.innerHTML = `ATTENTION: Please enter a value for the **Total Floor Plan Area** in Section 1.`;
                }
                
                // Set all final cost outputs to N/A or $0.00 when blocked
                document.getElementById('estimatedCost').textContent = '---';
                document.getElementById('totalLaborCostDisplay').textContent = '---';
                document.getElementById('estimatedMaterialsCostDisplay').textContent = '---';
                document.getElementById('ratePerSqFt').textContent = '---';
                document.getElementById('laborRatePerSqFt').textContent = '---';
                document.getElementById('materialsRatePerSqFt').textContent = '---';
                document.getElementById('weightedAvgLaborRatePerSheetrockSqFt').textContent = '---';
                document.getElementById('weightedAvgAllInRatePerSheetrockSqFt').textContent = '---';

            } else {
                validationWarning.classList.add('hidden');
                resultsContainer.classList.remove('opacity-50', 'pointer-events-none');

                // Update final cost outputs only when valid
                document.getElementById('estimatedCost').textContent = formatter.format(estimatedTotalCost);
                document.getElementById('totalLaborCostDisplay').textContent = formatter.format(totalLaborCost);
                document.getElementById('estimatedMaterialsCostDisplay').textContent = formatter.format(estimatedMaterialsCost);
                
                // Update Sheetrock Area Rates
                document.getElementById('weightedAvgLaborRatePerSheetrockSqFt').textContent = formatter.format(weightedAvgLaborRatePerSheetrockSqFt);
                document.getElementById('weightedAvgAllInRatePerSheetrockSqFt').textContent = formatter.format(weightedAvgAllInRatePerSheetrockSqFt);
                
                // Update Floor Area Rates
                document.getElementById('ratePerSqFt').textContent = formatter.format(ratePerFloorPlanSqFt);
                document.getElementById('laborRatePerSqFt').textContent = formatter.format(laborRatePerFloorPlanSqFt);
                document.getElementById('materialsRatePerSqFt').textContent = formatter.format(materialsRatePerFloorPlanSqFt);
            }

            // --- 9. Update All Other UI Elements ---
            
            // Area Summary
            document.getElementById('areaSummary').innerHTML = `Total Area Defined: <span class="text-blue-600">${totalDefinedArea.toFixed(0)}</span> sq ft / ${totalFloorArea.toFixed(0)} sq ft`;

            // Results Display
            document.getElementById('estimatedArea').textContent = totalSheetrockArea.toFixed(0) + ' sq ft';
            document.getElementById('totalAddersCost').textContent = formatter.format(totalAddersCost);
            document.getElementById('estimatedBeadLf').textContent = estimatedBeadLf.toFixed(0) + ' LF';
            document.getElementById('effectiveMultiplier').textContent = effectiveOverallMultiplier.toFixed(3) + 'x';
            
            // Store final variables globally for the summary generator
            window.finalFinishLevel = finalFinishLevel;
            window.totalSheetrockArea = totalSheetrockArea;
            window.estimatedTotalCost = estimatedTotalCost;
            window.totalFloorArea = totalFloorArea;
        }

        /**
         * Defines the description for each finish level.
         */
        function getFinishLevelDescription(level) {
            switch (level) {
                case 'L3': return "Level 3: Suitable for heavy texture application or surfaces to be covered with heavy-grade wall coverings. Includes two coats of joint compound on joints and one coat over fasteners.";
                case 'L4': return "Level 4: Standard finish for flat paint or light texture. Includes three coats of joint compound on all joints and fasteners. Requires priming.";
                case 'L5': return "Level 5: Highest quality, smoothest finish. Includes Level 4 requirements PLUS a skim coat (or equivalent finish) of joint compound over the entire surface. Recommended for gloss paints and critical lighting areas.";
                default: return "Finish Level details unavailable.";
            }
        }

        /**
         * Generates the customer-facing project summary (now with Exclusions and Assumptions).
         */
        function generateCustomerSummary() {
            if (!document.getElementById('validationWarning').classList.contains('hidden')) {
                // Use a custom message box instead of alert()
                document.getElementById('outputTitle').textContent = 'Cannot Generate Summary';
                document.getElementById('outputTextarea').value = "Please correct the validation error (Area Defined vs. Total Floor Area) before generating a summary.";
                document.getElementById('outputModal').classList.remove('hidden');
                return;
            }

            const area = window.totalFloorArea.toFixed(0);
            const sheetrockArea = window.totalSheetrockArea.toFixed(0);
            const totalCost = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(window.estimatedTotalCost);
            const finishLevelCode = window.finalFinishLevel;
            const finishLevelText = finishLevelCode.replace('L', 'Level ');
            const finishDescription = getFinishLevelDescription(finishLevelCode);
            const homeType = document.getElementById('homeType').options[document.getElementById('homeType').selectedIndex].text;

            const summary = `
--- PROJECT ESTIMATE AND QUOTATION ---
Contractor: [Your Company Name]
Client: [Client Name]
Date: ${new Date().toLocaleDateString()}
Total Floor Plan Area: ${area} sq ft
Estimated Sheetrock Area: ${sheetrockArea} sq ft

--------------------------------------------------
PROJECT SCOPE & INCLUSIONS
--------------------------------------------------
This quotation covers the professional labor and material costs for the installation and finishing of all required sheetrock for the ${homeType} structure (Total Area: ${area} sq ft).

1. FINISH LEVEL: **${finishLevelText}**
   > ${finishDescription}

2. MATERIALS: Includes standard 1/2" or 5/8" drywall, all necessary screws, taping compounds, and standard paper-faced or vinyl corner beads (estimated LF).

3. WORK: Includes framing inspection, board hanging, tape and mud application, and site cleanup related to the drywall process.

--------------------------------------------------
TOTAL ESTIMATED PROJECT CHARGE: ${totalCost}
--------------------------------------------------

--------------------------------------------------
ASSUMPTIONS AND CONDITIONS
--------------------------------------------------
The following conditions are assumed for this quotation. Any deviation may result in a change order or price adjustment:
* **Site Readiness:** The work area is clear of debris, plumbing, HVAC, and electrical work is complete, and the site is ready for dry-walling upon arrival.
* **Framing:** All framing is square, plumb, structurally sound, and meets local building code requirements.
* **Utilities:** Access to 120V power and running water is provided on-site.
* **Environment:** Adequate ventilation and temperature control (HVAC functional) are maintained to allow proper curing of joint compounds.

--------------------------------------------------
EXCLUSIONS (NOT INCLUDED IN THIS PRICE)
--------------------------------------------------
This quotation specifically excludes the following:
* Repair of any framing defects or corrections.
* Painting, priming, texturing, or wallpaper application.
* Supply or rental of specialized lifting equipment, scaffolding, or man-lifts required for extreme heights (over 16ft).
* Disposal or hauling of non-drywall construction debris (e.g., lumber, insulation).
* Any work related to fireproofing, soundproofing, or specialty wall finishes (e.g., Venetian plaster).
* Applicable sales tax or permit fees.

--- END OF QUOTATION ---
            `.trim();

            document.getElementById('outputTitle').textContent = 'Customer Project Quotation (Review and Copy)';
            document.getElementById('outputTextarea').value = summary;
            document.getElementById('outputModal').classList.remove('hidden');
        }

        /**
         * Generates the shareable URL link.
         */
        function generateShareableLink() {
            const params = new URLSearchParams();
            
            // Iterate through the URL_PARAM_MAP to collect current input values
            for (const [key, elementId] of Object.entries(URL_PARAM_MAP)) {
                const element = document.getElementById(elementId);
                if (element && element.value !== undefined) {
                    // Only include parameters if they differ from a default/zero value (optional optimization)
                    if (element.value !== '0.00' && element.value !== '0' && element.value !== '0.0') {
                        params.set(key, element.value);
                    }
                }
            }

            const currentUrl = window.location.origin + window.location.pathname;
            const shareableLink = `${currentUrl}?${params.toString()}`;

            document.getElementById('outputTitle').textContent = 'Shareable Link (Copy & Paste to open with these settings)';
            document.getElementById('outputTextarea').value = shareableLink;
            document.getElementById('outputModal').classList.remove('hidden');
        }
    </script>
</body>
</html>

